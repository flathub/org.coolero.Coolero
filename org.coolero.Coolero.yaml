app-id: org.coolero.Coolero
runtime: org.kde.Platform
runtime-version: '6.2'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm12
command: coolero
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=all
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.freedesktop.Flatpak
cleanup:
  - /include
  - /lib/pkgconfig
  - '*.la'
  - '*.a'
modules:
  # embed the version of python we want to use (can remove once flatpak upgrades to 3.10)
  - name: python
    sources:
      - type: archive
        url: https://www.python.org/ftp/python/3.10.2/Python-3.10.2.tar.xz
        md5: 14e8c22458ed7779a1957b26cde01db9
  # automatically added python deps needed for own version:
  - name: cython
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "cython==0.29.28" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/9f/79/311cfbca90332ab37ef8ea08f1af3266f20a9a0e7a1d652842db832226bb/Cython-0.29.28-py2.py3-none-any.whl
        sha256: 26d8d0ededca42be50e0ac377c08408e18802b1391caa3aea045a72c1bff47ac
  - name: wheel
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "wheel==0.37.1" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/27/d6/003e593296a85fd6ed616ed962795b2f87709c3eee2bca4f6d0fe55c6d00/wheel-0.37.1-py2.py3-none-any.whl
        sha256: 4bdcd7d840138086126cd09254dc6195fb4fc6f01c050a1d7236f2630db1d22a
  - name: six
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "six==1.16.0" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/d9/5a/e7c31adbe875f2abbb91bd84cf2dc52d792b5a01506781dbcf25c91daf11/six-1.16.0-py2.py3-none-any.whl
        sha256: 8abb2f1d86890a2dfb989f9a77cfcfd3e47c2a354b01111771326f8aa26e0254

  - shared-modules/libusb/libusb.json

  # prerequisites not handled by script
  - name: cppy
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} cppy
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/36/64/be592e84c443a70ea5dcfb1c30bfe6f10ba7d8eb05c2264c7ceca8498548/cppy-1.1.0.tar.gz
        sha256: 4eda6f1952054a270f32dc11df7c5e24b259a09fddf7bfaa5f33df9fb4a29642
  - name: pyamdgpuinfo
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} ./ --no-build-isolation
    sources:
      - type: git
        url: https://github.com/mark9064/pyamdgpuinfo.git
        tag: v2.1.2
        commit: 9cb0dd39fc2714493a422112f2216c3dfcfabfab
      - type: shell
        commands:
          - sed -i 's|/usr/include/libdrm|/app/include/libdrm|' setup.py
    modules:
      - name: libdrm
        buildsystem: simple
        build-commands:
          - meson build --prefix=/app
          - ninja -C build/ install
        sources:
          - type: git
            url: https://gitlab.freedesktop.org/mesa/drm.git
            tag: libdrm-2.4.108
            commit: d76c387125c7ad336f39121b9c3148361731bdad

  - py-dependencies.yaml

  - name: shiboken6
    buildsystem: simple
    build-options:
      prepend-path: /usr/lib/sdk/llvm12/bin
      prepend-ld-library-path: /usr/lib/sdk/llvm12/lib
    build-commands:
      - python3 setup.py install --verbose-build --skip-docs --build-type=shiboken6 --prefix=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/qtproject/pyside-pyside-setup.git
        tag: v6.2.3
        commit: 1966aae5401de5129f571fdb5bb1d9b1e69ab143
  - name: pyside6
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      prepend-path: /usr/lib/sdk/llvm12/bin
      prepend-ld-library-path: /usr/lib/sdk/llvm12/lib
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_TESTS=OFF
      - -DCMAKE_SKIP_RPATH:BOOL=YES
      - -DPYTHON_EXECUTABLE=/app/bin/python3
      - -DPYTHON_LIBRARY=/app/lib/libpython3.10.a
      - -DPYTHON_INCLUDE_DIR=/app/include/python3.10
    sources:
      - type: git
        url: https://github.com/qtproject/pyside-pyside-setup.git
        tag: v6.2.3
        commit: 1966aae5401de5129f571fdb5bb1d9b1e69ab143
      - type: shell
        commands:
          - mkdir -p /app/include/qt6tmp && cp -R /usr/include/Qt* /app/include/qt6tmp # https://bugreports.qt.io/broswse/PYSIDE-787
          - sed -i 's|--include-paths=|--include-paths=/app/include/qt6tmp:|' sources/pyside6/cmake/Macros/PySideModules.cmake
          - sed -i 's|<signature_p.h>|<signature/signature_p.h>|' sources/pyside6/libpyside/feature_select.cpp # fixes build issue introduced in 6.2.2

  - name: coolero
    buildsystem: simple
    build-commands:
      - cp -r coolero /app/coolero
      - mkdir -p /app/bin
      - install -Dm644 metadata/org.coolero.Coolero.png /app/share/icons/hicolor/scalable/apps/org.coolero.Coolero.png
      - install -Dm644 metadata/org.coolero.Coolero.desktop /app/share/applications/org.coolero.Coolero.desktop
      - install -Dm644 metadata/org.coolero.Coolero.metainfo.xml -t /app/share/metainfo
      - sed -i 's|/usr/bin/env python3|/app/bin/python3|' /app/coolero/coolero.py  # force use of own python version
      - ln -s /app/coolero/coolero.py /app/bin/coolero
    sources:
      - type: git
        url: https://gitlab.com/codifryed/coolero.git
        tag: 0.7.2
        commit: 758c308f2f6cf3128896d1eaa1b3d639d90be52b
        disable-submodules: true
